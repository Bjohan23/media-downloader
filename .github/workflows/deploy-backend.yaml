name: Build and Deploy Media Downloader Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yaml'
  workflow_dispatch:
    inputs:
      rollback_manual:
        description: 'Forzar rollback a versiÃ³n anterior'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: mediadownloader-backend
  CONTAINER_NAME: mediadownloader-backend
  NETWORK_DATA: data_net
  NETWORK_PROXY: proxy_net
  PORT: 3001

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Construir imagen Docker
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:latest ./backend
          docker save ${{ env.IMAGE_NAME }}:latest | gzip > image.tar.gz

      - name: Copiar imagen al servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "image.tar.gz"
          target: "/tmp"

      - name: Desplegar en servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            # --- CONFIGURACIÃ“N ---
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            NETWORK_DATA="${{ env.NETWORK_DATA }}"
            NETWORK_PROXY="${{ env.NETWORK_PROXY }}"
            PORT="${{ env.PORT }}"
            MAX_RETRIES=15
            RETRY_INTERVAL=3

            # --- FUNCIÃ“N: DiagnÃ³stico ---
            diagnostico() {
              echo "=== DIAGNÃ“STICO DE ERROR ==="
              docker ps -a --filter "name=$CONTAINER_NAME"
              docker logs "$CONTAINER_NAME" --tail 30 2>&1 || true
            }

            # --- FUNCIÃ“N: Conectar a redes ---
            conectar_redes() {
              docker network connect "$NETWORK_DATA" "$CONTAINER_NAME" 2>/dev/null || true
              docker network connect "$NETWORK_PROXY" "$CONTAINER_NAME" 2>/dev/null || true
            }

            # --- FUNCIÃ“N: Health Check ---
            health_check() {
              echo "Verificando salud en puerto $PORT..."
              for i in $(seq 1 $MAX_RETRIES); do
                echo "  Intento $i de $MAX_RETRIES..."
                if curl -sf --max-time 5 "http://127.0.0.1:${PORT}/api/health" > /dev/null 2>&1; then
                  echo "  âœ“ Health check exitoso"
                  return 0
                fi
                sleep $RETRY_INTERVAL
              done
              echo "  âœ— Health check fallÃ³ despuÃ©s de $MAX_RETRIES intentos"
              return 1
            }

            # --- FUNCIÃ“N: Ejecutar Contenedor ---
            run_container() {
              local TAG=$1
              docker run -d \
                --name "$CONTAINER_NAME" \
                --restart unless-stopped \
                -p ${PORT}:${PORT} \
                -e NODE_ENV="production" \
                -e PORT="${PORT}" \
                -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                -e FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                -e TZ="America/Lima" \
                -v mediadownloader_downloads:/app/downloads \
                "$IMAGE_NAME:$TAG"
            }

            # --- PROCESO PRINCIPAL ---

            # 1. Manejo de Rollback Manual
            if [ "${{ github.event.inputs.rollback_manual }}" = "true" ]; then
              echo "ğŸ”„ Iniciando Rollback Manual..."
              docker stop "$CONTAINER_NAME" 2>/dev/null || true
              docker rm "$CONTAINER_NAME" 2>/dev/null || true
              run_container "backup"
              conectar_redes
              echo "âœ“ Rollback completado"
              exit 0
            fi

            echo "[1/7] Cargando nueva imagen..."
            docker load < /tmp/image.tar.gz
            rm -f /tmp/image.tar.gz

            echo "[2/7] Gestionando Backup..."
            if docker images | grep -q "${IMAGE_NAME}:latest"; then
              docker tag "${IMAGE_NAME}:latest" "${IMAGE_NAME}:backup" 2>/dev/null || true
            fi

            echo "[3/7] Deteniendo contenedor anterior..."
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm "$CONTAINER_NAME" 2>/dev/null || true

            echo "[4/7] Iniciando nuevo contenedor..."
            run_container "latest"

            echo "[5/7] Conectando redes..."
            conectar_redes

            echo "[6/7] Verificando despliegue..."
            if health_check; then
              echo "âœ… DESPLIEGUE EXITOSO"
              docker image prune -f 2>/dev/null || true
            else
              echo "âŒ FALLÃ“ EL DESPLIEGUE, EJECUTANDO ROLLBACK..."
              diagnostico
              docker stop "$CONTAINER_NAME" 2>/dev/null || true
              docker rm "$CONTAINER_NAME" 2>/dev/null || true
              run_container "backup"
              conectar_redes
              echo "ğŸ”„ ROLLBACK COMPLETADO"
              exit 1
            fi

            echo "[7/7] Limpieza completada"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Backend desplegado en puerto $PORT"
            echo "URL: https://api.mediadownloader.johandev.lat"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
